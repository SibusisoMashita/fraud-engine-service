name: CI | Build | Scan | Smoke | Publish | Load Test

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

env:
  REGISTRY: ghcr.io

jobs:

  # =====================================================
  # 1) BUILD + UNIT TESTS + INTEGRATION TESTS + JAR
  # =====================================================
  build-test:
    runs-on: ubuntu-latest

    outputs:
      image_name: ${{ steps.repo.outputs.repo }}
      image_tags: ${{ steps.meta.outputs.tags }}
      jar_path: target/*.jar

    steps:
      - uses: actions/checkout@v4

      # Cache Maven Repo
      - name: Cache Maven Repo
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: m2-${{ hashFiles('**/pom.xml') }}
          restore-keys: m2-

      # Java 21
      - name: Set up Java 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21
          cache: maven

      # Build + Tests + Jacoco
      - name: Maven Build + Tests
        run: mvn -B clean verify

      # Upload Jacoco Report
      - name: Upload Jacoco Report
        uses: actions/upload-artifact@v4
        with:
          name: jacoco-report
          path: target/site/jacoco/

      # Normalize repo name for GHCR
      - name: Normalize repo to lowercase
        id: repo
        run: |
          R=$(echo "${{ github.repository }}" | tr '[:upper:]' '[:lower:]')
          echo "repo=$R" >> $GITHUB_OUTPUT

      # Extract Docker metadata
      - name: Docker Metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ steps.repo.outputs.repo }}
          tags: |
            type=sha
            type=ref,event=branch
            type=raw,value=latest,enable={{is_default_branch}}

      # Upload JAR
      - name: Upload JAR
        uses: actions/upload-artifact@v4
        with:
          name: fraud-engine-jar
          path: target/*.jar



  # =====================================================
  # 2) DOCKER BUILD + TRIVY SCAN + SMOKE TEST + PUSH
  # =====================================================
  docker:
    needs: build-test
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      security-events: write

    outputs:
      final_image: ${{ steps.meta.outputs.tags }}

    steps:
      - uses: actions/checkout@v4

      # Download JAR from previous job
      - name: Download JAR
        uses: actions/download-artifact@v4
        with:
          name: fraud-engine-jar
          path: target

      # Setup Buildx
      - uses: docker/setup-buildx-action@v3

      # Docker Cache
      - name: Cache Docker layers
        uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache
          key: buildx-${{ github.sha }}
          restore-keys: buildx-

      # GHCR Login
      - name: GHCR Login
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # Docker Metadata
      - name: Docker Metadata
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ghcr.io/${{ needs.build-test.outputs.image_name }}
        tags: |
          type=sha
          type=ref,event=branch
          type=raw,value=latest,enable={{is_default_branch}}

        # Build image once
        - name: Docker Build (cached)
          uses: docker/build-push-action@v5
          with:
            context: .
            push: false
            load: true
            tags: ${{ steps.meta.outputs.tags }}
            labels: ${{ steps.meta.outputs.labels }}
            cache-from: type=local,src=/tmp/.buildx-cache
            cache-to: type=local,dest=/tmp/.buildx-cache-new

        - name: Move Updated Docker Cache
          run: |
            rm -rf /tmp/.buildx-cache
            mv /tmp/.buildx-cache-new /tmp/.buildx-cache

        # --- SECURITY SCAN ----------------------------------
        - name: Trivy Scan
          uses: aquasecurity/trivy-action@master
          with:
            image-ref: ${{ steps.meta.outputs.tags }}
            format: sarif
            output: trivy-results.sarif

        - name: Upload SARIF
          uses: github/codeql-action/upload-sarif@v3
          with:
            sarif_file: trivy-results.sarif


        # --- SMOKE TEST --------------------------------------
        - name: Start Postgres
          run: |
            docker run -d \
              --name fraud-postgres \
              -e POSTGRES_DB=fraud_engine \
              -e POSTGRES_USER=postgres \
              -e POSTGRES_PASSWORD=admin \
              -p 5432:5432 postgres:15
            
            echo "Waiting for Postgres..."
            for i in {1..20}; do
              docker exec fraud-postgres pg_isready && break
              sleep 2
            done

        - name: Start Fraud Engine (Smoke Test)
          run: |
            docker run -d --name fraud-test \
              --network host \
              -e SPRING_PROFILES_ACTIVE=docker \
              ${{ steps.meta.outputs.tags }}
            
            sleep 25

        - name: Smoke Test /health
          run: |
            curl -v --fail http://localhost:8080/api/v1/health

        - name: Dump Logs on Failure
          if: failure()
          run: |
            docker logs fraud-test || true
            docker logs fraud-postgres || true

        # Push image only after smoke tests passed
        - name: Push Docker Image
          uses: docker/build-push-action@v5
          with:
            context: .
            push: true
            tags: ${{ steps.meta.outputs.tags }}
            labels: ${{ steps.meta.outputs.labels }}



  # =====================================================
  # 3) LOAD TEST (Uses the SAME Tested Image)
  # =====================================================
  load-test:
    needs: docker
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      # Pull tested image
      - name: Pull Tested Image
        run: |
          docker pull ${{ needs.docker.outputs.final_image }}
          docker tag ${{ needs.docker.outputs.final_image }} fraud-engine:latest

      # Start Postgres for load-test
      - name: Start Postgres
        run: |
          docker run -d \
            --name fraud-postgres \
            -e POSTGRES_DB=fraud_engine \
            -e POSTGRES_USER=postgres \
            -e POSTGRES_PASSWORD=admin \
            -p 5432:5432 postgres:15

          echo "Waiting for Postgres..."
          for i in {1..20}; do
            docker exec fraud-postgres pg_isready && break
            sleep 2
          done

      # Start Fraud Engine
      - name: Start Fraud Engine
        run: |
          docker run -d \
            --name fraud-engine \
            --network host \
            -e SPRING_PROFILES_ACTIVE=docker \
            fraud-engine:latest
          sleep 20

      # Cache NPM
      - name: Cache NPM
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: npm-${{ runner.os }}
          restore-keys: npm-

      # Install Newman
      - name: Install Newman
        run: sudo npm install -g newman newman-reporter-htmlextra

      # Run Load Tests
      - name: Run Load Tests
        run: |
          newman run postman/collection.json \
            -e postman/environment.json \
            --timeout-request 30000 \
            --reporters cli,htmlextra,json \
            --reporter-htmlextra-export newman-report.html \
            --reporter-json-export newman-report.json

      # Upload load test results
      - name: Upload Load Test Reports
        uses: actions/upload-artifact@v4
        with:
          name: load-test-reports
          path: |
            newman-report.html
            newman-report.json

      # Threshold enforcement
      - name: Enforce Performance Threshold
        run: |
          FAIL=$(jq '.run.stats.requests.failed' newman-report.json)
          if [ "$FAIL" -gt 5 ]; then
            echo "‚ùå Too many failures: $FAIL"
            exit 1
          fi
