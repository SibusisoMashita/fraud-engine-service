name: CI | Build | Scan | Smoke | Publish | Load Test

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

env:
  REGISTRY: ghcr.io

jobs:

  # =====================================================
  # 1) BUILD + UNIT TESTS + INTEGRATION TESTS + JAR
  # =====================================================
  build-test:
    runs-on: ubuntu-latest

    outputs:
      image_name: ${{ steps.repo.outputs.repo }}
      image_tags: ${{ steps.meta.outputs.tags }}

    steps:
      - uses: actions/checkout@v4

      - name: Cache Maven Repo
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: m2-${{ hashFiles('**/pom.xml') }}
          restore-keys: m2-

      - name: Set up Java 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21
          cache: maven

      - name: Maven Build + Tests
        run: mvn -B clean verify

      - name: Upload Jacoco Report
        uses: actions/upload-artifact@v4
        with:
          name: jacoco-report
          path: target/site/jacoco/

      - name: Normalize repo to lowercase
        id: repo
        run: |
          R=$(echo "${{ github.repository }}" | tr '[:upper:]' '[:lower:]')
          echo "repo=$R" >> $GITHUB_OUTPUT

      - name: Docker Metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ steps.repo.outputs.repo }}
          tags: |
            type=sha
            type=ref,event=branch
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Upload JAR
        uses: actions/upload-artifact@v4
        with:
          name: fraud-engine-jar
          path: target/*.jar



  # =====================================================
  # 2) DOCKER BUILD + SCAN + SMOKE TEST + PUSH
  # =====================================================
  docker:
    needs: build-test
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      security-events: write

    outputs:
      final_image: ${{ steps.single.outputs.tag }}

    steps:
      - uses: actions/checkout@v4

      - name: Download JAR
        uses: actions/download-artifact@v4
        with:
          name: fraud-engine-jar
          path: target

      - name: Set up Buildx
        uses: docker/setup-buildx-action@v3

      - name: Cache Docker layers
        uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache
          key: buildx-${{ github.sha }}
          restore-keys: buildx-

      - name: GHCR Login
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Docker Metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ needs.build-test.outputs.image_name }}
          tags: |
            type=sha
            type=ref,event=branch
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Extract Single Image Tag (SHA)
        id: single
        run: |
          echo "tag=$(echo '${{ steps.meta.outputs.tags }}' | head -n 1)" >> $GITHUB_OUTPUT

      - name: Docker Build (cached)
        uses: docker/build-push-action@v5
        with:
          context: .
          push: false
          load: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=local,src=/tmp/.buildx-cache
          cache-to: type=local,dest=/tmp/.buildx-cache-new

      - name: Move Updated Docker Cache
        run: |
          rm -rf /tmp/.buildx-cache
          mv /tmp/.buildx-cache-new /tmp/.buildx-cache

      - name: Trivy Scan
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ steps.single.outputs.tag }}
          format: sarif
          output: trivy-results.sarif

      - name: Upload SARIF
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: trivy-results.sarif

      # Upload Trivy SARIF as a workflow artifact for easy access
      - name: Upload Trivy Scan Artifact
        uses: actions/upload-artifact@v4
        with:
          name: trivy-scan
          path: trivy-results.sarif

      - name: Start Postgres
        run: |
          docker run -d \
            --name fraud-postgres \
            -e POSTGRES_DB=fraud_engine \
            -e POSTGRES_USER=postgres \
            -e POSTGRES_PASSWORD=admin \
            -p 5432:5432 postgres:15

          echo "Waiting for Postgres..."
          for i in {1..20}; do
            docker exec fraud-postgres pg_isready && break
            sleep 2
          done

      - name: Start Fraud Engine (Smoke Test)
        run: |
          docker run -d --name fraud-test \
            --network host \
            -e SPRING_PROFILES_ACTIVE=docker \
            ${{ steps.single.outputs.tag }}

          sleep 25

      - name: Smoke Test /health
        run: |
          curl -v --fail http://localhost:8080/api/v1/health

      - name: Dump Logs on Failure
        if: failure()
        run: |
          docker logs fraud-test || true
          docker logs fraud-postgres || true

      - name: Push Docker Image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}



  # =====================================================
  # 3) LOAD TEST
  # =====================================================
  load-test:
    needs: docker
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Pull Tested Image
        run: |
          docker pull ${{ needs.docker.outputs.final_image }}
          docker tag ${{ needs.docker.outputs.final_image }} fraud-engine:latest

      - name: Start Postgres
        run: |
          docker run -d \
            --name fraud-postgres \
            -e POSTGRES_DB=fraud_engine \
            -e POSTGRES_USER=postgres \
            -e POSTGRES_PASSWORD=admin \
            -p 5432:5432 postgres:15

          echo "Waiting for Postgres..."
          for i in {1..20}; do
            docker exec fraud-postgres pg_isready && break
            sleep 2
          done

      - name: Start Fraud Engine
        run: |
          docker run -d \
            --name fraud-engine \
            --network host \
            -e SPRING_PROFILES_ACTIVE=docker \
            fraud-engine:latest
          sleep 20


      # ===========================================
      #  JWT AUTHENTICATION (only update added)
      # ===========================================
      - name: Authenticate to get JWT token
        run: |
          echo "Requesting JWT..."
          RESPONSE=$(curl -s -X POST http://localhost:8080/auth/login \
            -H "Content-Type: application/json" \
            -d '{"username":"admin", "password":"password123"}')

          TOKEN=$(echo $RESPONSE | jq -r '.token')

          if [ "$TOKEN" = "null" ] || [ -z "$TOKEN" ]; then
            echo "❌ Failed to retrieve JWT token"
            echo "Response: $RESPONSE"
            exit 1
          fi

          echo "Retrieved token: $TOKEN"

          jq --arg t "$TOKEN" '.values += [{"key":"token","value":$t,"type":"string"}]' \
            postman/environment.json > postman/environment.updated.json

          mv postman/environment.updated.json postman/environment.json


      - name: Cache NPM
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: npm-${{ runner.os }}
          restore-keys: npm-

      - name: Install Newman
        run: sudo npm install -g newman newman-reporter-htmlextra

      - name: Run Load Tests
        run: |
          newman run postman/collection.json \
            -e postman/environment.json \
            --iteration-count 100 \
            --timeout-request 30000 \
            --reporters cli,htmlextra,json \
            --reporter-htmlextra-export newman-report.html \
            --reporter-json-export newman-report.json

      - name: Upload Load Test Reports
        uses: actions/upload-artifact@v4
        with:
          name: load-test-reports
          path: |
            newman-report.html
            newman-report.json

      - name: Enforce Performance Threshold
        run: |
          FAIL=$(jq '.run.stats.requests.failed' newman-report.json)
          if [ "$FAIL" -gt 5 ]; then
            echo "❌ Too many failures: $FAIL"
            exit 1
          fi
